WITH _T0 AS (
  SELECT
    ANY_VALUE(TIMES.t_name) AS ANYTHING_T_NAME,
    ANY_VALUE(TIMES.t_start_hour) AS ANYTHING_T_START_HOUR,
    AVG(SEARCHES.search_num_results) AS AVG_SEARCH_NUM_RESULTS,
    COUNT(*) AS N_ROWS
  FROM TIMES AS TIMES
  JOIN SEARCHES AS SEARCHES
    ON TIMES.t_end_hour > HOUR(CAST(SEARCHES.search_ts AS TIMESTAMP))
    AND TIMES.t_start_hour <= HOUR(CAST(SEARCHES.search_ts AS TIMESTAMP))
  GROUP BY
    TIMES.t_name
)
SELECT
  ANYTHING_T_NAME AS tod,
  ROUND((
    100.0 * N_ROWS
  ) / SUM(N_ROWS) OVER (), 2) AS pct_searches,
  ROUND(AVG_SEARCH_NUM_RESULTS, 2) AS avg_results
FROM _T0
ORDER BY
  ANYTHING_T_START_HOUR NULLS FIRST
