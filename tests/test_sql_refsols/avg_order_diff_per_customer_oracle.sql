WITH _T1 AS (
  SELECT
    CUSTOMER.c_name AS C_NAME,
    ORDERS.o_custkey AS O_CUSTKEY,
    DATEDIFF(
      CAST(ORDERS.o_orderdate AS DATETIME),
      CAST(LAG(ORDERS.o_orderdate, 1) OVER (PARTITION BY ORDERS.o_custkey ORDER BY ORDERS.o_orderdate) AS DATETIME),
      DAY
    ) AS DAY_DIFF
  FROM TPCH.CUSTOMER CUSTOMER
  JOIN TPCH.NATION NATION
    ON CUSTOMER.c_nationkey = NATION.n_nationkey AND NATION.n_name = 'JAPAN'
  JOIN TPCH.ORDERS ORDERS
    ON CUSTOMER.c_custkey = ORDERS.o_custkey AND ORDERS.o_orderpriority = '1-URGENT'
)
SELECT
  ANY_VALUE(C_NAME) AS name,
  AVG(DAY_DIFF) AS avg_diff
FROM _T1
GROUP BY
  O_CUSTKEY
ORDER BY
  2 DESC NULLS LAST
FETCH FIRST 5 ROWS ONLY
