WITH "_S0" AS (
  SELECT
    ca_dt AS CA_DT
  FROM MAIN.CALENDAR
), "_T2" AS (
  SELECT
    pr_name AS PR_NAME,
    pr_release AS PR_RELEASE
  FROM MAIN.PRODUCTS
  WHERE
    pr_name = 'RubyCopper-Star'
), "_S12" AS (
  SELECT DISTINCT
    TRUNC(CAST("_S0".CA_DT AS TIMESTAMP), 'QUARTER') AS QUARTER
  FROM "_S0" "_S0"
  JOIN "_T2" "_T2"
    ON "_S0".CA_DT < TRUNC(CAST("_T2".PR_RELEASE AS TIMESTAMP) + NUMTOYMINTERVAL(2, 'year'), 'QUARTER')
    AND "_S0".CA_DT >= "_T2".PR_RELEASE
), "_T5" AS (
  SELECT
    pr_id AS PR_ID,
    pr_name AS PR_NAME
  FROM MAIN.PRODUCTS
  WHERE
    pr_name = 'RubyCopper-Star'
), "_S9" AS (
  SELECT
    COUNTRIES.co_id AS CO_ID,
    "_T5".PR_ID
  FROM "_T5" "_T5"
  JOIN MAIN.COUNTRIES COUNTRIES
    ON COUNTRIES.co_name = 'CN'
), "_S13" AS (
  SELECT
    TRUNC(CAST("_S2".CA_DT AS TIMESTAMP), 'QUARTER') AS QUARTER,
    COUNT(DISTINCT INCIDENTS.in_device_id) AS NDISTINCT_IN_DEVICE_ID
  FROM "_S0" "_S2"
  JOIN "_T2" "_T4"
    ON "_S2".CA_DT < TRUNC(CAST("_T4".PR_RELEASE AS TIMESTAMP) + NUMTOYMINTERVAL(2, 'year'), 'QUARTER')
    AND "_S2".CA_DT >= "_T4".PR_RELEASE
  JOIN MAIN.INCIDENTS INCIDENTS
    ON "_S2".CA_DT = TRUNC(CAST(INCIDENTS.in_error_report_ts AS TIMESTAMP), 'DAY')
  JOIN "_S9" "_S9"
    ON INCIDENTS.in_repair_country_id = "_S9".CO_ID
  JOIN MAIN.DEVICES DEVICES
    ON DEVICES.de_id = INCIDENTS.in_device_id AND DEVICES.de_product_id = "_S9".PR_ID
  GROUP BY
    TRUNC(CAST("_S2".CA_DT AS TIMESTAMP), 'QUARTER')
), "_S21" AS (
  SELECT
    TRUNC(CAST("_S14".CA_DT AS TIMESTAMP), 'QUARTER') AS QUARTER,
    COUNT(*) AS N_ROWS
  FROM "_S0" "_S14"
  JOIN "_T2" "_T8"
    ON "_S14".CA_DT < TRUNC(CAST("_T8".PR_RELEASE AS TIMESTAMP) + NUMTOYMINTERVAL(2, 'year'), 'QUARTER')
    AND "_S14".CA_DT >= "_T8".PR_RELEASE
  JOIN MAIN.DEVICES DEVICES
    ON "_S14".CA_DT = TRUNC(CAST(DEVICES.de_purchase_ts AS TIMESTAMP), 'DAY')
  JOIN "_T5" "_T9"
    ON DEVICES.de_product_id = "_T9".PR_ID
  GROUP BY
    TRUNC(CAST("_S14".CA_DT AS TIMESTAMP), 'QUARTER')
)
SELECT
  "_S12".QUARTER AS quarter,
  COALESCE("_S13".NDISTINCT_IN_DEVICE_ID, 0) AS n_incidents,
  COALESCE("_S21".N_ROWS, 0) AS n_sold,
  ROUND(
    SUM(COALESCE("_S13".NDISTINCT_IN_DEVICE_ID, 0)) OVER (ORDER BY "_S12".QUARTER ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) / SUM(COALESCE("_S21".N_ROWS, 0)) OVER (ORDER BY "_S12".QUARTER ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW),
    2
  ) AS quarter_cum
FROM "_S12" "_S12"
LEFT JOIN "_S13" "_S13"
  ON "_S12".QUARTER = "_S13".QUARTER
LEFT JOIN "_S21" "_S21"
  ON "_S12".QUARTER = "_S21".QUARTER
ORDER BY
  1 NULLS FIRST
