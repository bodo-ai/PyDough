WITH _T3 AS (
  SELECT
    ca_dt AS CALENDAR_DAY
  FROM MAIN.CALENDAR
), _T0 AS (
  SELECT
    COUNT(*) AS N_PURCHASES,
    ANY_VALUE(_T3.CALENDAR_DAY) AS START_OF_PERIOD
  FROM _T3 AS _T3
  CROSS JOIN _T3 AS _S1
  JOIN MAIN.DEVICES AS DEVICES
    ON _S1.CALENDAR_DAY = DATE_TRUNC('DAY', CAST(DEVICES.de_purchase_ts AS TIMESTAMP))
  WHERE
    YEAR(_T3.CALENDAR_DAY) = 2024
    AND _S1.CALENDAR_DAY < DATEADD(DAY, 5, CAST(_T3.CALENDAR_DAY AS TIMESTAMP))
    AND _S1.CALENDAR_DAY >= _T3.CALENDAR_DAY
  GROUP BY
    _T3.CALENDAR_DAY
)
SELECT
  START_OF_PERIOD AS start_of_period,
  N_PURCHASES AS n_purchases
FROM _T0
ORDER BY
  N_PURCHASES DESC NULLS LAST,
  START_OF_PERIOD NULLS FIRST
LIMIT 1
