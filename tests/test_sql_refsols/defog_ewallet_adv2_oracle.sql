SELECT
  TRUNC(CAST(NOTIFICATIONS.created_at AS TIMESTAMP), 'WEEK') AS week,
  COUNT(*) AS num_notifs,
  COALESCE(
    SUM((
      MOD((
        TO_CHAR(NOTIFICATIONS.created_at, 'D') + 5
      ), 7)
    ) IN (5, 6)),
    0
  ) AS weekend_notifs
FROM MAIN.NOTIFICATIONS NOTIFICATIONS
JOIN MAIN.USERS USERS
  ON NOTIFICATIONS.user_id = USERS.uid AND USERS.country IN ('US', 'CA')
WHERE
  NOTIFICATIONS.created_at < TRUNC(SYS_EXTRACT_UTC(SYSTIMESTAMP), 'WEEK')
  AND NOTIFICATIONS.created_at >= (
    TRUNC(SYS_EXTRACT_UTC(SYSTIMESTAMP), 'WEEK') + NUMTODSINTERVAL(3, 'week')
  )
GROUP BY
  TRUNC(CAST(NOTIFICATIONS.created_at AS TIMESTAMP), 'WEEK')
