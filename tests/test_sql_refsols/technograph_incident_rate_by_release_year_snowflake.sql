WITH _S0 AS (
  SELECT
    COUNT(*) AS AGG_1,
    de_product_id AS PRODUCT_ID
  FROM MAIN.DEVICES
  GROUP BY
    de_product_id
), _T4 AS (
  SELECT
    pr_id AS _ID,
    pr_release AS RELEASE_DATE
  FROM MAIN.PRODUCTS
), _S6 AS (
  SELECT
    SUM(_S0.AGG_1) AS AGG_1,
    DATE_PART(YEAR, _T4.RELEASE_DATE) AS RELEASE_YEAR
  FROM _S0 AS _S0
  JOIN _T4 AS _T4
    ON _S0.PRODUCT_ID = _T4._ID
  GROUP BY
    DATE_PART(YEAR, _T4.RELEASE_DATE)
), _S7 AS (
  SELECT
    COUNT(*) AS AGG_0,
    DATE_PART(YEAR, _T6.RELEASE_DATE) AS RELEASE_YEAR
  FROM MAIN.DEVICES AS DEVICES
  JOIN _T4 AS _T6
    ON DEVICES.de_product_id = _T6._ID
  JOIN MAIN.INCIDENTS AS INCIDENTS
    ON DEVICES.de_id = INCIDENTS.in_device_id
  GROUP BY
    DATE_PART(YEAR, _T6.RELEASE_DATE)
)
SELECT
  _S6.RELEASE_YEAR AS year,
  ROUND(COALESCE(_S7.AGG_0, 0) / _S6.AGG_1, 2) AS ir
FROM _S6 AS _S6
LEFT JOIN _S7 AS _S7
  ON _S6.RELEASE_YEAR = _S7.RELEASE_YEAR
ORDER BY
  YEAR NULLS FIRST
