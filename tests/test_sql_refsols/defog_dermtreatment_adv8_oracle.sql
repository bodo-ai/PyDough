WITH "_T0" AS (
  SELECT
    TRUNC(CAST(start_dt AS TIMESTAMP), 'MONTH') AS START_MONTH,
    COUNT(*) AS N_ROWS,
    COUNT(DISTINCT diag_id) AS NDISTINCT_DIAG_ID
  FROM MAIN.TREATMENTS
  WHERE
    DATE_SUB(TRUNC(CURRENT_TIMESTAMP, 'MONTH'), 12, MONTH) <= TRUNC(CAST(start_dt AS TIMESTAMP), 'MONTH')
    AND TRUNC(CAST(start_dt AS TIMESTAMP), 'MONTH') < TRUNC(CURRENT_TIMESTAMP, 'MONTH')
  GROUP BY
    TRUNC(CAST(start_dt AS TIMESTAMP), 'MONTH')
)
SELECT
  LISTAGG(
    '-',
    EXTRACT(YEAR FROM START_MONTH),
    CASE
      WHEN LENGTH(EXTRACT(MONTH FROM START_MONTH)) >= 2
      THEN SUBSTR(EXTRACT(MONTH FROM START_MONTH), 1, 2)
      ELSE SUBSTR(CONCAT('00', EXTRACT(MONTH FROM START_MONTH)), -2)
    END
  ) AS start_month,
  NDISTINCT_DIAG_ID AS PMPD,
  N_ROWS AS PMTC
FROM "_T0"
ORDER BY
  1 DESC NULLS LAST
